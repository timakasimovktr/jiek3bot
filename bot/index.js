const { Telegraf, Scenes, session, Markup } = require("telegraf");
require("dotenv").config();
const pool = require("../db");
const bookingWizard = require("./bookingScene");
const adminChatId = process.env.ADMIN_CHAT_ID;

const bot = new Telegraf(process.env.BOT_TOKEN);
const stage = new Scenes.Stage([bookingWizard]);

const fs = require("fs");
const path = require("path");
const PizZip = require("pizzip");
const Docxtemplater = require("docxtemplater");

bot.use(session());
bot.use(stage.middleware());

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function getLatestPendingId(userId) {
  const [rows] = await pool.query(
    "SELECT id FROM bookings WHERE status = 'pending' AND user_id = ? ORDER BY id DESC LIMIT 1",
    [userId]
  );
  return rows.length ? rows[0].id : null;
}

async function getLatestPendingIdWithoutStatus(userId) {
  const [rows] = await pool.query(
    "SELECT id FROM bookings WHERE user_id = ? ORDER BY id DESC LIMIT 1",
    [userId]
  );
  return rows.length ? rows[0].id : null;
}

async function getUserBookingStatus(userId) {
  const [rows] = await pool.query(
    "SELECT * FROM bookings WHERE user_id = ? ORDER BY id DESC LIMIT 1",
    [userId]
  );
  return rows.length ? rows : null;
}

function buildMainMenu(latestPendingId) {
  const rows = [
    ["üìä Navbat holati", "üì± Grupaga otish", "üñ®Ô∏è Ariza nusxasini olish"],
  ];

  if (latestPendingId) {
    rows.push([`‚ùå Arizani bekor qilish #${latestPendingId}`]);
  } else {
    rows.push(["‚ùå Arizani bekor qilish"]);
  }

  return Markup.keyboard(rows).resize();
}

async function getQueuePosition(bookingId) {
  const [rows] = await pool.query(
    "SELECT id FROM bookings WHERE status = 'pending' ORDER BY id ASC"
  );
  const ids = rows.map((row) => row.id);
  const position = ids.indexOf(bookingId);
  return position !== -1 ? position + 1 : null;
}

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –°–¢–ê–†–¢
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.start(async (ctx) => {
  await ctx.reply(
    "üëã Assalomu alaykum!\nBu platforma orqali siz qamoqxona mahbuslari bilan uchrashuvga yozilishingiz mumkin.",
    Markup.inlineKeyboard([
      [Markup.button.callback("üìÖ Uchrashuvga yozilish", "start_booking")],
    ])
  );
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –ó–ê–ü–£–°–ö –°–¶–ï–ù–´
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.action("start_booking", async (ctx) => {
  await ctx.answerCbQuery();
  await ctx.scene.enter("booking-wizard");
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –í–ù–£–¢–†–ò–°–¶–ï–ù–û–í–ê–Ø –û–¢–ú–ï–ù–ê –ß–ï–†–ù–û–í–ò–ö–ê (inline "cancel")
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.action("cancel", async (ctx) => {
  // –≠—Ç–æ –û–¢–ú–ï–ù–ê –ß–ï–†–ù–û–í–ò–ö–ê –≤ –≤–∏–∑–∞—Ä–¥–µ (–ù–ï –æ—Ç–º–µ–Ω–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏!)
  if (ctx.scene && ctx.scene.leave) {
    await ctx.scene.leave();
  }
  ctx.session = {};
  ctx.wizard.state = {};
  await ctx.answerCbQuery();
  await ctx.reply(
    "‚ùå Uchrashuv yozuvi bekor qilindi.",
    Markup.inlineKeyboard([
      [Markup.button.callback("üìÖ Uchrashuvga yozilish", "start_booking")],
    ])
  );
  await ctx.scene.leave();
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  NAVBAT HOLATI
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.hears("üìä Navbat holati", async (ctx) => {
  try {
    const latestId = await getLatestPendingIdWithoutStatus(ctx.from.id);
    if (!latestId) {
      return ctx.reply(
        "‚ùå Sizda hozirda kutayotgan ariza yo‚Äòq.",
        buildMainMenu(null)
      );
    }
    const pos = await getQueuePosition(latestId);
    const rowInfo = await getUserBookingStatus(ctx.from.id);
    const relatives = JSON.parse(rowInfo[0].relatives);

    if (rowInfo[0].status === "approved") {
      await ctx.reply(
        `üéâ Ariza tasdiqlangan. Nomer: ${latestId}
üë§ Arizachi: ${relatives[0].full_name}
üìÖ Berilgan sana: ${new Date().toLocaleString("ru-RU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        })}
‚åöÔ∏è Kelishi sana: ${new Date(
          new Date(rowInfo[0].start_datetime).getTime() +
            1 * 24 * 60 * 60 * 1000
        ).toLocaleString("ru-RU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        })}
üü¢ Holat: Tasdiqlangan`,
        buildMainMenu(latestId)
      );

      return;
    }

    if (!pos) {
      return ctx.reply("‚ùå Navbat topilmadi.", buildMainMenu(latestId));
    }

    await ctx.reply(`üìä Sizning navbatingiz: ${pos}`, buildMainMenu(latestId));
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

bot.hears("üì± Grupaga otish", async (ctx) => {
  try {
    await ctx.reply(
      "üì± Tugmasini bosing:",
      Markup.inlineKeyboard([
        [
          Markup.button.url(
            "üìå Grupaga otish",
            "https://t.me/+qWg7Qh3t_OIxMDBi"
          ),
        ],
      ])
    );
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  ¬´–ù–ï –û–¢–ú–ï–ù–Ø–¢–¨¬ª (–æ—Ç–∫–∞–∑ –æ—Ç –æ—Ç–º–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞—è–≤–∫–∏)
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.hears("‚ùå Yo‚Äòq", async (ctx) => {
  try {
    ctx.session.confirmCancel = false;
    ctx.session.confirmCancelId = null;

    const latestId = await getLatestPendingId(ctx.from.id);

    await ctx.reply(
      "‚úÖ Ariza bekor qilinmadi.",
      Markup.keyboard(buildMainMenu(latestId).reply_markup.keyboard).resize()
    );
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –ó–ê–ü–†–û–° –û–¢–ú–ï–ù–´ (—Å ID –∏–ª–∏ –±–µ–∑ ID ‚Äî –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.hears(/^‚ùå Arizani bekor qilish(?:\s*#(\d+))?$/i, async (ctx) => {
  try {
    // 1) –ï—Å–ª–∏ –µ—Å—Ç—å id –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π pending
    const explicitId = ctx.match && ctx.match[1] ? Number(ctx.match[1]) : null;
    const latestId =
      explicitId || (await getLatestPendingIdWithoutStatus(ctx.from.id));

    if (!latestId) {
      return ctx.reply(
        "‚ùå Sizda bekor qilish uchun ariza topilmadi.",
        buildMainMenu(null)
      );
    }

    // 2) –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏—é
    ctx.session.confirmCancel = true;
    ctx.session.confirmCancelId = latestId;

    // 3) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await ctx.reply(
      "‚ùì Arizani bekor qilmoqchimisiz?",
      Markup.keyboard([["‚úÖ Ha", "‚ùå Yo‚Äòq"]]).resize()
    );
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

/** ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–¢–ú–ï–ù–´ –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –ó–ê–Ø–í–ö–ò
 *  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
bot.hears("‚úÖ Ha", async (ctx) => {
  try {
    const bookingId = ctx.session.confirmCancelId;
    if (!ctx.session.confirmCancel || !bookingId) {
      return ctx.reply("‚ùå Hozir bekor qilish uchun ariza topilmadi.");
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    ctx.session.confirmCancel = false;
    ctx.session.confirmCancelId = null;

    const [result] = await pool.query(
      "UPDATE bookings SET status = 'canceled' WHERE id = ? AND user_id = ? ",
      [bookingId, ctx.from.id]
    );

    if (result.affectedRows === 0) {
      return ctx.reply("‚ùå Ariza topilmadi yoki allaqachon bekor qilingan.");
    }

    // –£–∑–Ω–∞–µ–º –∏–º—è –¥–ª—è –∞–¥–º–∏–Ω–∞
    const [rows] = await pool.query(
      "SELECT relatives FROM bookings WHERE id = ?",
      [bookingId]
    );
    let bookingName = "Noma'lum";
    if (rows.length && rows[0].relatives) {
      try {
        const relatives = JSON.parse(rows[0].relatives);
        if (Array.isArray(relatives) && relatives.length > 0) {
          bookingName = relatives[0].full_name || "Noma'lum";
        }
      } catch (e) {
        console.error("JSON parse error:", e);
      }
    }

    // –ß–∏—Å—Ç–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º
    await ctx.reply("‚ùå Sizning arizangiz bekor qilindi.", {
      reply_markup: { remove_keyboard: true },
    });

    if (ctx.scene && ctx.scene.leave) {
      await ctx.scene.leave();
    }
    ctx.session = {};

    // –°–æ–æ–±—â–∞–µ–º –∞–¥–º–∏–Ω—É
    try {
      await ctx.telegram.sendMessage(
        adminChatId,
        `‚ùå Ariza bekor qilindi. Nomer: ${bookingId}\nüßë Arizachi: ${bookingName}`
      );
    } catch (err) {
      if (err.response && err.response.error_code === 403) {
        console.warn("‚ö†Ô∏è Admin botni bloklagan, xabar yuborilmadi");
      } else {
        console.error("Telegram API error:", err);
      }
    }

    // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
    await ctx.reply(
      "üîÑ Yangi uchrashuvga yozilish uchun quyidagi tugmani bosing:",
      Markup.inlineKeyboard([
        [Markup.button.callback("üìÖ Uchrashuvga yozilish", "start_booking")],
      ])
    );
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

bot.catch((err, ctx) => {
  if (err.response && err.response.error_code === 403) {
    console.warn(`‚ö†Ô∏è User ${ctx.from?.id} blocked the bot, skip message`);
  } else {
    console.error("‚ùå Global error:", err);
  }
});

bot.hears("Yangi ariza yuborish", async (ctx) => {
  try {
    await ctx.scene.enter("booking-wizard");
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi.");
  }
});

bot.hears("üñ®Ô∏è Ariza nusxasini olish", async (ctx) => {
  try {
    const latestId = await getLatestPendingIdWithoutStatus(ctx.from.id);
    if (!latestId) {
      return ctx.reply("‚ùå Sizda hozirda kutayotgan ariza yo‚Äòq.");
    }

    // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
    const [bookingRows] = await pool.query(
      "SELECT * FROM bookings WHERE id = ?",
      [latestId]
    );
    if (!bookingRows.length) {
      return ctx.reply("‚ùå Ariza topilmadi.");
    }
    const booking = bookingRows[0];

    // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ library
    const [libRows] = await pool.query("SELECT * FROM library LIMIT 1");
    const library = libRows[0] || { placeNumber: "", commander: "" };

    // –ü–∞—Ä—Å–∏–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤
    let relatives = [];
    try {
      relatives = booking.relatives ? JSON.parse(booking.relatives) : [];
    } catch (e) {
      console.error("JSON parse error:", e);
    }

    // –î–æ—Å—Ç–∞—ë–º –∫–∞–∂–¥–æ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ
    const rel1 = relatives[0] || {};
    const rel2 = relatives[1] || {};
    const rel3 = relatives[2] || {};

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω
    const templatePath = path.join(__dirname, "ariza.docx");
    const content = fs.readFileSync(templatePath, "binary");
    const zip = new PizZip(content);

    const doc = new Docxtemplater(zip, {
      paragraphLoop: true,
      linebreaks: true,
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–±–ª–æ–Ω
    doc.render({
      placeNumber: library.placeNumber,
      commander: library.commander,
      fullname: rel1.full_name || "",
      passport: rel1.passport || "",
      fullname2:
        rel2.full_name ||
        "____________________________________________________",
      passport2: rel2.passport || "",
      fullname3:
        rel3.full_name ||
        "____________________________________________________",
      passport3: rel3.passport || "",
      prisoner: booking.prisoner_name || "",
      arizaNumber: booking.id || "",
      today: new Date().toLocaleDateString("uz-UZ"),
    });

    const buf = doc.getZip().generate({ type: "nodebuffer" });

    await ctx.replyWithDocument({
      source: buf,
      filename: `ariza_${latestId}.docx`,
    });
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi (–ø–µ—á–∞—Ç—å).");
  }
});

bot.launch().then(() => console.log("üöÄ Bot ishga tushdi"));
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
