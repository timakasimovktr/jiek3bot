const { Telegraf, Scenes, session, Markup } = require("telegraf");
const pool = require("../db");

const MAX_RELATIVES = 3;
const SHORT_ROOM_START = 1;
const LONG_ROOM_START = 21;

const bookingWizard = new Scenes.WizardScene(
  "booking-wizard",

  // Step 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  async (ctx) => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏
      const [rows] = await pool.query(
        "SELECT * FROM bookings WHERE user_id = ? AND status = 'pending' ORDER BY id DESC LIMIT 1",
        [ctx.from.id]
      );

      if (rows.length > 0) {
        await ctx.reply(
          "‚ö†Ô∏è Sizda hali tugallanmagan ariza mavjud. Yangi ariza yaratish uchun uni yakunlang yoki bekor qiling.",
          Markup.keyboard([
            ["üìä Navbat holati"],
            ["‚ùå Arizani bekor qilish"],
          ]).resize()
        );
        return ctx.scene.leave();
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const [userRows] = await pool.query(
        "SELECT phone_number FROM bookings WHERE user_id = ?",
        [ctx.from.id]
      );

      if (userRows.length > 0 && userRows[0].phone_number) {
        ctx.wizard.state.phone = userRows[0].phone_number;

        await ctx.reply(`ü§ñ Tartibga rioya qiling!`, Markup.removeKeyboard());

        // —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
        ctx.wizard.state.relatives = [];
        ctx.wizard.state.currentRelative = {};
        ctx.wizard.state.prisoner_name = null;
        ctx.wizard.state.visit_type = null;

        await ctx.reply(
          "üìÖ Iltimos, uchrashuv turini tanlang:",
          Markup.inlineKeyboard([
            [Markup.button.callback("üîµ 1-kunlik", "short")],
            [Markup.button.callback("üü¢ 2-kunlik", "long")],
          ])
        );
        return ctx.wizard.selectStep(2); // —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ Step 2
      }

      // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç ‚Üí –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏
      await ctx.reply(
        "üì≤ Iltimos, telefon raqamingizni yuboring:",
        Markup.keyboard([[Markup.button.contactRequest("üìû Raqamni yuborish")]])
          .resize()
          .oneTime()
      );
      return ctx.wizard.next();
    } catch (err) {
      console.error(err);
      await ctx.reply(
        "‚ùå Xatolik yuz berdi. Iltimos, keyinroq urinib ko‚Äòring."
      );
      return ctx.scene.leave();
    }
  },

  // Step 1: –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç
  async (ctx) => {
    if (ctx.message?.contact?.phone_number) {
      ctx.wizard.state.phone = ctx.message.contact.phone_number; // —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º state

      await ctx.reply(
        "‚úÖ Telefon raqamingiz qabul qilindi.",
        Markup.removeKeyboard()
      );

      ctx.wizard.state.relatives = [];
      ctx.wizard.state.currentRelative = {};
      ctx.wizard.state.prisoner_name = null;
      ctx.wizard.state.visit_type = null;

      await ctx.reply(
        "üìÖ Iltimos, uchrashuv turini tanlang:",
        Markup.inlineKeyboard([
          [Markup.button.callback("üîµ 1-kunlik", "short")],
          [Markup.button.callback("üü¢ 2-kunlik", "long")],
        ])
      );
      return ctx.wizard.next();
    } else {
      await ctx.reply("‚ùå Telefon raqamingizni faqat tugma orqali yuboring.");
      return;
    }
  },

  // Step 2: –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–∏–∑–∏—Ç–∞
  async (ctx) => {
    if (
      ctx.callbackQuery?.data === "long" ||
      ctx.callbackQuery?.data === "short"
    ) {
      await ctx.answerCbQuery();
      ctx.wizard.state.visit_type = ctx.callbackQuery.data;

      await ctx.reply(
        "üë§ Iltimos, to‚Äòliq ismingiz va familiyangizni kiriting:"
      );
      return ctx.wizard.next();
    } else {
      await ctx.reply("‚ùå Iltimos, uchrashuv turini tanlang.");
    }
  },

  // Step 3: Ism va familiya
  async (ctx) => {
    if (ctx.message?.text === "‚ùå Bekor qilish ariza") {
      await ctx.reply(
        "‚ùå Uchrashuv yozuvi bekor qilindi.",
        Markup.keyboard([["üìÖ Uchrashuvga yozilish"]]).resize()
      );
      return ctx.scene.leave();
    }

    if (!ctx.message?.text) {
      await ctx.reply("‚ùå Iltimos, ism va familiyani matn shaklida yuboring.");
      return ctx.wizard.selectStep(3);
    }

    ctx.wizard.state.currentRelative.full_name = ctx.message.text.toUpperCase();

    await ctx.reply(
      "üõÇ Endi pasport seriyasi va raqamini kiriting (masalan: AB1234567):"
    );
    return ctx.wizard.next();
  },

  // Step 4: Passport va mahbus ismi
  async (ctx) => {
    if (!ctx.message?.text) {
      await ctx.reply("‚ùå Iltimos, pasport raqamini matn shaklida yuboring.");
      return ctx.wizard.selectStep(3);
    }

    ctx.wizard.state.currentRelative.passport = ctx.message.text.toUpperCase();
    ctx.wizard.state.relatives.push(ctx.wizard.state.currentRelative);

    if (!ctx.wizard.state.prisoner_name) {
      await ctx.reply(
        "üë• Siz kim bilan uchrashmoqchisiz? Mahbusning to‚Äòliq ismini kiriting:"
      );
      return ctx.wizard.next(); // Step 5
    } else {
      // agar mahbus ismi allaqachon bo'lsa ‚Üí to'g'ridan-to'g'ri qo'shimcha savol
      return askAddMore(ctx);
    }
  },

  // Step 5: Mahbus ismi (faqat birinchi marta)
  async (ctx) => {
    if (!ctx.message?.text) {
      await ctx.reply("‚ùå Iltimos, mahbusning ismini matn shaklida yuboring.");
      return ctx.wizard.selectStep(5);
    }

    ctx.wizard.state.prisoner_name = ctx.message.text.toUpperCase();
    return askAddMore(ctx);
  },

  // Step 6: Qo‚Äòshimcha qarindosh yoki yakunlash
  async (ctx) => {
    if (ctx.callbackQuery) await ctx.answerCbQuery();

    if (ctx.callbackQuery?.data === "add_more") {
      if (ctx.wizard.state.relatives.length < MAX_RELATIVES) {
        ctx.wizard.state.currentRelative = {};
        await ctx.reply(
          "üë§ Yangi qarindoshning ismi va familiyasini kiriting:"
        );
        return ctx.wizard.selectStep(3);
      } else {
        await ctx.reply("‚ö†Ô∏è Maksimal 3 ta qarindosh qo‚Äòshildi.");
        return showSummary(ctx);
      }
    } else if (ctx.callbackQuery?.data === "done") {
      return showSummary(ctx);
    }
  },

  // Step 7: Yakuniy tasdiqlash yoki bekor qilish
  async (ctx) => {
    if (ctx.callbackQuery) await ctx.answerCbQuery();

    if (ctx.callbackQuery?.data === "confirm") {
      return saveBooking(ctx);
    } else if (ctx.callbackQuery?.data === "cancel") {
      await ctx.reply(
        "‚ùå Uchrashuv yozuvi bekor qilindi.",
        Markup.inlineKeyboard([
          [Markup.button.callback("üìÖ Uchrashuvga yozilish", "start_booking")],
        ])
      );
      return ctx.scene.leave();
    }
  }
);

// helper: qo‚Äòshish yoki yakunlash
async function askAddMore(ctx) {
  if (ctx.wizard.state.relatives.length < MAX_RELATIVES) {
    await ctx.reply(
      "‚ûï Yana qarindosh qo‚Äòshishni xohlaysizmi? (maksimal 3 ta)",
      Markup.inlineKeyboard([
        [Markup.button.callback("Ha, qo‚Äòshaman", "add_more")],
        [Markup.button.callback("Yo‚Äòq", "done")],
      ])
    );
    return ctx.wizard.selectStep(6);
  } else {
    await ctx.reply("‚ö†Ô∏è Maksimal 3 ta qarindosh qo‚Äòshildi.");
    return showSummary(ctx);
  }
}

// helper: ko‚Äòrsatish summary
async function showSummary(ctx) {
  const { prisoner_name, relatives } = ctx.wizard.state;
  let text = "üìã Arizangiz tafsilotlari:\n\n";
  text += `üë• Mahbus: ${prisoner_name}\n\n`;
  relatives.forEach((r, i) => {
    text += `üë§ Qarindosh ${i + 1}:\n- Ism Familiya: ${
      r.full_name
    }\n- Pasport: ${r.passport}\n\n`;
  });
  text += "‚ùì Ushbu ma‚Äôlumotlarni tasdiqlaysizmi?";

  await ctx.reply(
    text,
    Markup.inlineKeyboard([
      [Markup.button.callback("‚úÖ Tasdiqlash", "confirm")],
      [Markup.button.callback("‚ùå Bekor qilish ariza", "cancel")],
    ])
  );
  return ctx.wizard.selectStep(7);
}

// helper: save booking to DB
async function saveBooking(ctx) {
  const { prisoner_name, relatives, visit_type } = ctx.wizard.state;
  const chatId = ctx.chat.id;
  const adminChatId = process.env.ADMIN_CHAT_ID;
  const submissionDate = new Date();
  try {
    const [result] = await pool.query(
      "INSERT INTO bookings (user_id, phone_number, visit_type, prisoner_name, relatives, status, telegram_chat_id) VALUES (?, ?, ?, ?, ?, 'pending', ?)",
      [
        ctx.from.id,
        ctx.wizard.state.phone,
        visit_type,
        prisoner_name,
        JSON.stringify(relatives),
        chatId,
      ]
    );

    const bookingId = result.insertId;

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –∫–æ–º–Ω–∞—Ç—ã
    const daysToAdd = visit_type === 'short' ? 1 : 2;
    const maxRooms = visit_type === 'short' ? 20 : 10;
    const roomStart = visit_type === 'short' ? SHORT_ROOM_START : LONG_ROOM_START;
    const rooms = Array.from({ length: maxRooms }, (_, i) => roomStart + i);

    let currentDate = new Date(submissionDate);
    currentDate.setDate(currentDate.getDate() + 10);
    currentDate.setHours(0, 0, 0, 0);

    let assigned = false;
    let assignedDate, assignedRoom;
    const maxAttempts = 365;

    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      let start = new Date(currentDate);
      let end = new Date(currentDate);
      end.setDate(end.getDate() + daysToAdd);

      const startStr = start.toISOString().slice(0, 19).replace('T', ' ');
      const endStr = end.toISOString().slice(0, 19).replace('T', ' ');

      for (let room of rooms) {
        const [overlapRows] = await pool.query(
          "SELECT COUNT(*) as count FROM bookings WHERE status = 'approved' AND room_id = ? AND NOT (end_datetime <= ? OR start_datetime >= ?)",
          [room, startStr, endStr]
        );

        if (overlapRows[0].count === 0) {
          assignedDate = start;
          assignedRoom = room;
          assigned = true;
          break;
        }
      }

      if (assigned) break;

      currentDate.setDate(currentDate.getDate() + 1);
    }

    await ctx.scene.leave();

    if (!assigned) {
      // –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º pending
      await ctx.telegram.sendMessage(adminChatId, `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –¥–∞—Ç—É –¥–ª—è –∑–∞—è–≤–∫–∏ ‚Ññ${bookingId}. –°–ª–∏—à–∫–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω–æ.`);
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏ (–¥–ª—è pending)
      const [rows] = await pool.query(
        "SELECT * FROM bookings WHERE status = 'pending' ORDER BY id ASC"
      );
      const myIndex = rows.findIndex((b) => b.id === bookingId);
      const position = myIndex + 1;

      await ctx.reply(
        `‚úÖ Uchrashuv muvaffaqiyatli bron qilindi, lekin hali tasdiqlanmagan (admin tasdiqlashi kerak).\n\nüìä Sizning navbatingiz: ${position}`,
        Markup.keyboard([
          ["üìä Navbat holati"],
          [`‚ùå Arizani bekor qilish #${bookingId}`],
        ])
          .resize()
          .oneTime(false)
      );
    } else {
      // –ù–∞–∑–Ω–∞—á–∞–µ–º
      const startStr = assignedDate.toISOString().slice(0, 19).replace('T', ' ');
      await pool.query(
        "UPDATE bookings SET status='approved', start_datetime=?, end_datetime=DATE_ADD(?, INTERVAL ? DAY), room_id=? WHERE id=?",
        [startStr, startStr, daysToAdd, assignedRoom, bookingId]
      );

      const relativeName = relatives[0].full_name || "Noma'lum";

      const messageUser = `
üéâ Ariza tasdiqlangan. Nomer: ${bookingId}
üë§ Arizachi: ${relativeName}
üìÖ Berilgan sana: ${submissionDate.toLocaleString("ru-RU", { day: "2-digit", month: "2-digit", year: "numeric" })}
‚åö Kelishi sana: ${assignedDate.toLocaleString("ru-RU", { day: "2-digit", month: "2-digit", year: "numeric" })}
‚è≤Ô∏è Turi: ${visit_type === "long" ? "2-kunlik" : "1-kunlik"}
üü¢ Holat: Tasdiqlangan
`;

      await ctx.reply(messageUser, Markup.keyboard([
        ["üìä Navbat holati", "üì± Grupaga otish", "üñ®Ô∏è Ariza nusxasini olish"],
        [`‚ùå Arizani bekor qilish #${bookingId}`],
      ]).resize());

      const messageGroup = `
üéâ Ariza tasdiqlangan. Nomer: ${bookingId}
üë§ Arizachi: ${relativeName}
üìÖ Berilgan sana: ${submissionDate.toLocaleString("ru-RU", { day: "2-digit", month: "2-digit", year: "numeric" })}
‚åö Kelishi sana: ${assignedDate.toLocaleString("ru-RU", { day: "2-digit", month: "2-digit", year: "numeric" })}
üü¢ Holat: Tasdiqlangan
`;

      await ctx.telegram.sendMessage(adminChatId, messageGroup);
    }

    await ctx.reply(
      "üì± Grupaga qo'shing",
      Markup.inlineKeyboard([
        [
          Markup.button.url(
            "üìå Grupaga otish",
            "https://t.me/+qWg7Qh3t_OIxMDBi"
          ),
        ],
      ])
    );
  } catch (err) {
    console.error(err);
    await ctx.reply("‚ùå Xatolik yuz berdi. Iltimos, keyinroq urinib ko‚Äòring.");
  }
}

async function sendApplicationToAdmin(ctx, application) {
  const adminChatId = process.env.ADMIN_CHAT_ID;
  const firstRelative = application.relatives[0];
  const text = `üìå Yangi ariza. Nomer: ${application.id}
üë§ Arizachi: ${firstRelative ? `${firstRelative.full_name}` : "Noma'lum"}
üìÖ Berilgan sana: ${new Date().toLocaleString("ru-RU", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  })}
‚è≤Ô∏è Turi: ${application.visit_type === "long" ? "2-kunlik" : "1-kunlik"}
üü° Holat: Tekshiruvni kutish`;

  await ctx.reply(text);
  await ctx.telegram.sendMessage(adminChatId, text, { parse_mode: "Markdown" });
}

module.exports = bookingWizard;